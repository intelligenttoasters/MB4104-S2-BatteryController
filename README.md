# [FULL DISCLOSURE - I am not a python programmer and this code was generated by AI - there will be bugs - use at your own risk]

# MB4104-S2-BatteryController
This is a library and application code to manage the PowerTech S2 2048Wh Portable Battery. This is also known under the Jaycar part code MB4104. A HomeAssistant MQTT client also publishes the battery statistics and relay switches to HomeAssistant.

This battery has an IOT button that when pressed will enable bluetooth and WIFI and allow the registration of the battery linked to your account. Once the battery is linked to your WIFI, it has an open port that allows a query/response to monitor the battery statistics. Control of the power relays is also possible with this library.

## Registration Process
The first step is to register the battery to your account. Follow the instructions in the manual to download and install the mobile app, then register a new account.
https://media.jaycar.com.au/product/resources/MB4104_manualMain_156879.pdf
After registration, make sure bluetooth is on. Also connect your phone WIFI to the WIFI connection that you will use for the battery.

Follow the prompts to search for a new battery. When it's found, register the battery to your account. After this is complete, you will see your battery stats on your phone.
Now you'll see a banner that invites you to connect your battery to WIFI. Touch the banner and it will go through the process of requesting the password for your connected WIFI. 

_You can't change your AP, which is why we connected to correct AP earlier_.

After providing the password, your battery will connect to your WIFI. You should see the WIFI symbol on the battery stop flashing.
Now you can turn **off** your bluetooth. If everything is set up correctly, you'll still be able to see your battery stats and control the relays from the app.

## Download and run the test application
Now clone the Git repository and run 
```bash
python scripts/ups_dashboard.py --host <battery_ip_address> --verbose
```

If all went well, you should see your battery stats in the console. You may need to check your router DHCP server to find the IP address. Pressing 1,2 or 3 will allow you to toggle the power relays.

## Python prerequisites
To install the python prerequsites, just run:
```
python -m pip install paho-mqtt
```

## Run the HomeAssistant monitor
A MQTT configuration is required to connect to your HomeAssistant instance. First install the MQTT plug-in for HomeAssistant if this isn't already installed. 

From ```Settings>Devices and Services``` click the ```Add integration``` button in the bottom right corner of the Window.
Enter MQTT into the search and click the right arrow. A menu of MQTT functions will appear, just select MQTT again.
When MQTT has installed, you'll be asked to configure the plug-in with a user ID and password. Choose something secure and remember your choice.

Copy ```secrets.py-template``` to ```secrets.py``` inside the scripts folder and edit the content with your HomeAssistant instance information.
Inside this file the parameters are:
* MQTT_BROKER - Your hostname or IP address of your HomeAssistant instance
* MQTT_PORT - Leave this at the default 1883 unless you changed it in your HomsAssistant configuration
* MQTT_USERNAME - This is the username you selected when configuring the MQTT plug-in
* MQTT_PASSWORD - This is the password you selected when configuring the MQTT plug-in

Now, running the HomeAssistant monitor is as simple as running the python script with
```cmd
python .\scripts\mqtt_client.py --ups-host <battery_ip_address> --verbose
```
or
```bash
python ./scripts/mqtt_client.py --ups-host <battery_ip_address> --verbose
```
Running the monitor with verbose for the first time will show some debug information to show you that it's working. Look for any errors, such as ```connection error: timed out``` messages.

The monitor runs silently without the ```--verbose``` flag and can be run this way in production to lighten the load on the server. Adjust the ```--interval``` to control how often HomeAssistant is updated with the battery state. More frequently will be more responsive, but will add to your HomeAssistant load and could slow other operations.